---
layout:     post   				    # 使用的布局（不需要改）
title:      Network Notes(3)		# 标题 
subtitle:   ARP协议 #副标题
date:       2021-08-17		# 时间
author:     Leo 						# 作者
header-img: img/post-bg-hacker.jpg	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - Computer Network
---

# ARP协议特性


## 1 基本功能

Address Resolution Protocol：地址解析协议--->通过目标设备的IP地址，查询目标设备的MAC地址

## 2 应用场景

* 一台连入互连网的计算机拥有两个地址：一个是IP地址，每一台在互联

上的计算机都必须有一个惟一IP地址；另一个地址是网卡地址MAC地址，

MAC地址是一个固定在网卡中的全球独一无二的地址。通过MAC地址，以太

网就能独立于上层协议收发数据。当两台主机进行通信时，IP数据被封装成

以太帧格式的一个个的数据包，这些数据包通过数据链路层进行传送，ARP

消息就被封装在以太帧的数据部分 。

* 每一台基于TCP/IP协议的主机都有一个ARP缓存表 。如果一台主机A要与

另一台主机B进行数据通信，且它们位于一个网段时，它们之间的具体通信过

程如下：A查看自己的ARP缓存表，寻找B机器的相关信息，如果找到的话，

就使用表中与B的IP地址对应的MAC地址来通信；若查找失败，就会向局域网

中发送一个以太网的广播帧，往帧中填充A主机的IP地址和MAC地址，B主机

的IP地址等字段形成一个ARP请求。

* 此时此网段内的所有机器都会收到此请求，但只有B主机收到后发现此请

求中有自己的IP地址从而作出响应。它先刷新自己的ARP缓存，以便提高以

后的通信效率，而后生成一个ARP应答帧将自己的MAC地址填充进去发送给

A主机。A收到后将B的ARP信息写入自己的ARP缓存中。

## 3 ARP协议

### 3.1 ARP报文格式

| 字段             | 长度 | 含义                                                         |
| :--------------- | :--- | :----------------------------------------------------------- |
| 以太网目的地址   | 6    | 以太网目的地址。发送ARP请求时，为广播的MAC地址，0xFF.FF.FF.FF.FF.FF |
| 以太网源地址     | 6    | 以太网源地址                                                 |
| 帧类型           | 2    | 表示后面数据的类型。对ARP请求或应答来说，该字段值为0x8086    |
| 硬件类型         | 2    | 表示硬件地址的类型。对以太网，该值为1                        |
| 协议类型         | 2    | 表示发送方要映射的协议地址类型。对于IP地址，该值为0x0800     |
| 硬件地址长度     | 1    | 表示硬件地址的长度，单位是字节。对于ARP请求或应答来说，该值为6 |
| 协议地址长度     | 1    | 表示协议地址的长度，单位是字节。对于ARP请求或应答来说，该值为4 |
| OP               | 2    | 操作类型（ARP请求：1，ARP应答：2，RARP请求：3，RAPR应答：4） |
| 发送端以太网地址 | 6    | 发送方以太网地址。这个字段和ARP首部的源以太网地址字段是重复信息 |
| 发送端IP地址     | 4    | 发送方的IP地址                                               |
| 目的以太网地址   | 6    | 接收方的以太网地址。发送ARP请求时，该处填充为0x00.00.00.00.00.00 |
| 目的IP地址       | 4    | 接收方IP地址                                                 |

### 3.2 免费ARP报文

免费ARP (gratuitous ARP)。它是指主机发送ARP查找自己的IP地址 。

场景：配置IP地址时，广播免费ARP。

作用：

1.检查是否有地址冲突（另一台主机设置了相同的IP地址）。

2.如果发送免费ARP的主机正好改变了硬件地址（主机关机，然后更换网卡并重新启动），那么这个分组就可以使其他主机缓存中旧的硬件地址进行更新。

### 3.3 ARP表项

* 动态ARP:

动态ARP表项由ARP协议通过ARP报文自动生成和维护，可以被老化，可以被新的ARP报文更新，可以被静态ARP 表项覆盖。当到达老化时间、接口down时会删除相应的动态ARP表项。

* 静态ARP：

配置静态ARP表项可以增加通信的安全性。静态ARP 表项可以限制和指定IP地址的设备通信时只使用指定的MAC地址，此时攻击报文无法修改此表项的IP地址和MAC地址的映射关系，从而保护了本设备和指定设备间的正常通信。

静态ARP表项通过手工配置和维护，不会被老化，不会被动态ARP表项覆盖。

* 半动态ARP

配置静态ARP虽然增加了通信安全信，但出接口不可更改。

配置的静态ARP在不指定出接口的时候，能通过ARP MISS触发学习该用户的ARP同时根据学习到的ARP刷洗静态ARP的出接口。当VRRP主备切换或者STP阻塞端口变化时，流量路径发生变化，能根据MAC的变化再次刷新静态ARP（没有配置出接口）的出接口。

* 严格学习

使能ARP严格学习功能后，交换机只会根据自己发出的ARP请求报文的应答报文来学习ARP。



# 4 ARP处理流程



### 4.1 ARP报文接收处理

#### 4.1.1 收到ARP请求报文


<script src="/js/mermaid.min.js"></script>

<div class="mermaid">
graph TD
A[收到ARP请求报文]-->B{检查报文字段}
	B --> |不正确|C[丢弃]
B --> |正确|D{查找路由}
	D --> |非同网段|C
D --> |同网段|F{请求是否本接口}
	F --> |是本接口|G[更新动态ARP 发送ARP应答]
F --> |不是本接口|H{存在该动态ARP}
	H --> |否|C
	H --> |是|I[更新动态ARP]
</div>

#### 4.1.2 收到ARP应答报文

<div class="mermaid">
graph TD
A[收到ARP应答报文]-->B{检查报文字段}
	B --> |不正确|C[丢弃]
B --> |正确|D{查找路由}
	D --> |非同网段|C
D --> |同网段|F{目的IP是否本接口}
	F --> |是本接口|G[更新动态ARP]
F --> |不是本接口|C
</div>

### 4.2 ARP报文发送

触发ARP报文发送的情况：

* 接收ARP请求报文
* IP层查询ARP时没有ARP
* 动态ARP条目老化
* 接口状态或参数变化










