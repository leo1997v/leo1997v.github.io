---
layout:     post   				    # 使用的布局（不需要改）
title:      Java Notes(2)		# 标题 
subtitle:   线程，进程，协程；线程内存模型，JVM内存模型；锁 #副标题
date:       2021-05-21			# 时间
author:     Leo 						# 作者
header-img: img/post-bg-java.png	#这篇文章标题背景图片
catalog: true 						# 是否归档
tags:								#标签
    - Programming Language
    - Java
---

# 1 进程，线程，协程

## 1.1 进程
  
进程就是正在运行的应用程序。保存在磁盘上的程序运行以后，会在内存空间里形成一个独立的内存体，这个内存体有自己独立的地址空间，有自己的堆。进程是**资源分配的最小单位** 。操作系统会以每个进程为单位分配系统资源（CPU时间片，内存等资源）。

## 1.2 线程
  
线程是**CPU分配和调度的最小单位**。

- 线程的并发与并行
  
  并发是指多个线程交替进行。并行是指多个线程同时执行。并行意味着并发，但并发并不一定意味着并行，尤其是运行在单核CPU上时。

  单核多线程：单核CPU轮流执行多个线程，通过对每个线程分配CPU时间来实现，只能是并发的。

  多核多线程：可把多线程分配给不同的核心处理，其他的线程依旧等待，是并行执行。

- 线程状态
  
  ![](/img/post-img/post-Java-Notes-2/1.png)

  
## 1.3 进程与线程的区别与联系
    
- 区别：
  - 调度：线程作为调度和分配的基本单位，进程作为拥有资源的基本单位。

  - 并发性：不仅进程之间可以并发执行，同一个进程的多个线程之间也可并发执行。

  - 拥有资源：进程是拥有资源的一个独立单位，线程不拥有系统资源，但可以访问隶属于进程的资源。

  - 系统开销：在创建或撤消进程时，由于系统都要为之分配和回收资源，导致系统的开销明显大于创建或撤消线程时的开销。但是进程有独立的地址空间，一个进程崩溃后，在保护模式下不会对其它进程产生影响，而线程只是一个进程中的不同执行路径。线程有自己的堆栈和局部变量，但线程之间没有单独的地址空间，一个进程死掉就等于所有的线程死掉，所以多进程的程序要比多线程的程序健壮，但在进程切换时，耗费资源较大，效率要差一些。

- 联系：

  - 一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程；

  - 资源分配给进程，同一进程的所有线程共享该进程的所有资源；

  - 处理机分给线程，即真正在处理机上运行的是线程；

  - 线程在执行过程中，需要协作同步。不同进程的线程间要利用消息通信的办法实现同步。

## 1.4 协程

- 概念
  
  协程是一种基于线程之上，更轻量级的存在，一个线程可以拥有多个协程。协程完全由程序所控制，也就是在用户态执行，对于内核是不可见的。

- 原理 
  
  子程序，或者称为函数，在所有语言中都是层级调用，比如A调用B，B在执行过程中又调用了C，C执行完毕返回，B执行完毕返回，最后是A执行完毕。所以子程序调用是通过栈实现的，一个线程就是执行一个子程序。子程序调用总是一个入口，一次返回，调用顺序是明确的。而协程的调用和子程序不同。

  协程在子程序内部是可中断的，然后转而执行别的子程序，在适当的时候再返回来接着执行。

- 协程的优势
    
    **极高的执行效率**：线程的切换由操作系统来负责调度，而协程的切换完全由程序自己控制，减少了上下文切换的开销，极大提高了执行效率。线程的阻塞状态是由操作系统内核来进行切换，发生在内核态上，而协程的暂停完全由程序控制，发生在用户态上。


    **占用更少的资源**：在jdk 1.5+版本中，一个线程默认占用的内存是1MB，而在GoLang中一个协程（go routine）平均占用的内存只有2.5KB。Go从语言层面原生支持协程，所以说Go原生支持高并发。
    
    
    **不需要多线程的锁机制**：因为只有一个线程，也不存在同时写变量冲突，在协程中**控制共享资源不加锁**，所以执行效率比多线程高很多。



